/**
*  This test if for controlling a single range sensor
*/
target Python

reactor Sensor(max_length(1360), max_difference(400), offset(25 msec), period(25 msec)) {
    preamble {=
        import sys
        import signal
        import time
        import VL53L1X
        import threading

        def run_sensor(self):
            tof = self.VL53L1X.VL53L1X(1, i2c_address=0x29)
            tof.open()
            tof.start_ranging(1)
            global action

            while 1:
                distance_in_mm = tof.get_distance()
                if distance_in_mm < self.max_length:
                    action.schedule(0, distance_in_mm)
                self.time.sleep(0.1)

                
    =}

    timer t(offset, period);

    physical action blocked

    output distance;    // A number with non-zero means an obstacle blcked the sensor
                                    // The number is the distance between this sensor and the obstacle
                                    // An output with zero means the obstacle has disappeared
    reaction (startup) -> blocked {=
        global action
        action = blocked
        t = self.threading.Thread(target=self.run_sensor)
        t.start()
    =}

    reaction(blocked) -> distance {=
        print("Send output {}".format(blocked.value))
        distance.set(blocked.value)

        #print("Distance: {}mm".format(distance_in_mm))
    =}
}
